<html>
<head>
  <meta charset="utf-8">
  <!-- http://garden.zendesk.com -->
  <!--link rel="stylesheet" href="https://assets.zendesk.com/apps/sdk-assets/css/0/zendesk_garden.css" type="text/css"-->
  <link href="https://cdn.jsdelivr.net/bootstrap/2.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="main.css" rel="stylesheet">
</head>
<body>
  <h3 class="u-gamma" data-main>Loading...</h3>
  <section data-main></section>
  <div id="content"></div>

  <!-- https://github.com/zendesk/zendesk_app_framework_sdk -->
  <script src="https://cdn.jsdelivr.net/jquery/3.0.0/jquery.min.js"></script>
  <script type="text/javascript" src="https://assets.zendesk.com/apps/sdk/2.0/zaf_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.5/handlebars.min.js"></script>
  <!--script type="text/javascript" src="main.js"-->

  <script id="tickets-template" type="text/x-handlebars-template">
    <div>
      {{#if tickets}}
        <table class="table table-condensed">
          <tbody>
            {{#each tickets}}

              <tr>
                <td>#{{id}}: <a class="related-ticket-link" data-ticket-id={{id}} href="#" data-url="{{../base_url}}/agent/tickets/{{id}}">{{subject}}</a></td>
              </tr>

              {{#if ../preview_enabled}}
              <tr class="preview">
                <td>{{description}}</td>
              </tr>
              {{/if}}

            {{/each}}
          </tbody>
        </table>
      {{else}}
        <div>{{t "global.no_results"}}</div>
      {{/if}}
    </div>
  </script>


  <script type="text/javascript">
  $(function() {
   // Initialise the Zendesk JavaScript API client
    // https://developer.zendesk.com/apps/docs/apps-v2
    var client = ZAFClient.init();

    function renderTitle(text) {
      var mainSectionEl = document.querySelector('h3[data-main]');
      mainSectionEl.innerText = text;
    }

    function renderText(text) {
      var mainSectionEl = document.querySelector('section[data-main]');
      mainSectionEl.innerText = text;
    }

    function renderHtml(html) {
      var mainSectionEl = document.querySelector('section[data-main]');
      mainSectionEl.innerHTML = html;
    }

    function getCurrentUser() {
      return client.get('currentUser').then(function(data) {
        return data['currentUser'];
      });
    }

    function renderTicketsTable(tickets){
      if(tickets.count<1){return};
      var first = tickets.results[0];
      var url_data = getLocation(first.url);
      var base_url = url_data["protocol"] + '//' + url_data["hostname"];
      console.log("base_url:" + base_url);

      //console.log(tickets.results);
      /*html = '<div><table class="table table-condensed"><tbody>';
      tickets.results.forEach(function(ticket, index) {
        console.log(ticket);
        html = html + renderTicket(ticket);
      });
      html = html + '</tbody></table>';
      renderHtml(html);*/

      var source = $("#tickets-template").html();
      var template = Handlebars.compile(source);
      var data = { 'tickets': tickets.results, 'base_url': base_url };
      var html = template(data);
      $("#content").html(html);
      $('a.related-ticket-link').on('click', function(e) {
          e.preventDefault();
          console.log("event:");
          console.log(e);
          var ticketId = $(this).data('ticket-id');
          console.log("ticketID: " + ticketId);
          if (ticketId ){
            client.invoke('routeTo', 'ticket', ticketId);
          }
      });

    }

    function renderTicket(ticket){
      url_data = getLocation(ticket.url);
      ticket_url = url_data["protocol"] + '//' + url_data["hostname"] + '/agent/tickets/' + ticket.id;
      html = '<tr><td>#' + ticket.id + ':  <a class="related-ticket-link" data-ticket-id=' + ticket.id + ' href="' + ticket_url + '">' + ticket.subject + '</a></td></tr>';
      return html;
    }

    function getLocation(href) {
      var match = href.match(/^(https?\:)\/\/(([^:\/?#]*)(?:\:([0-9]+))?)([\/]{0,1}[^?#]*)(\?[^#]*|)(#.*|)$/);
      return match && {
          href: href,
          protocol: match[1],
          host: match[2],
          hostname: match[3],
          port: match[4],
          pathname: match[5],
          search: match[6],
          hash: match[7]
      }
    }

    /*function onRelatedTicketLinkClicked: function(e) {
      e.preventDefault();

      console.log(e);

      /*if (e.target.dataset && e.target.dataset.ticketId) {
        const client = this.zafClient;

        client.invoke('routeTo', 'ticket', e.target.dataset.ticketId);
      }
    }*/


    function init(metadata) {

      settings = metadata.settings
      console.log("custom_field_id: " + settings.custom_field_id);

      key = 'ticket.customField:custom_field_' + settings.custom_field_id;
      client.get(key).then(function(data) {
        var hotel = data[key];
        console.log(hotel);
        //console.log(data); // { "ticket.requester.name": "Mikkel Svane" }
        //search.json?query=tags:premium_support
        var fetchSelf = {
          url: '/api/v2/search.json?query=tags:' + hotel + ' order_by:updated_at sort:desc',
          type: 'GET',
          dataType: 'json'
        };
        client.request(fetchSelf).then(function(data2) {
          //console.dir(data2);
          renderTitle('Tickets related to ' +  hotel + ': ' + data2.count);
          renderTicketsTable( data2 );
        });
      });
    }

    client.invoke('resize', { width: '100%', height: '280px' });
    client.metadata().then(function(metadata) {
      init(metadata);
    });
  });
</script>

  

</body>
</html>
